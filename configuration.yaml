# Loads default set of integrations. Do not remove.
default_config:

# Load frontend themes from the themes folder
frontend:
  themes: !include_dir_merge_named themes

homeassistant: # https://www.home-assistant.io/blog/2015/05/09/utc-time-zone-awareness/
  time_zone: CET # Europe/Berlin without DST adaptations

  # https://www.home-assistant.io/docs/configuration/customizing-devices/
  customize:
    sensor.power_balance:
      # icon: mdi:lightbulb # would override the template sensor icon definition

      # https://community.home-assistant.io/t/how-to-change-icons-colour-of-template-sensor-in-lovelace/107619
      # is ignored, likely due to incomplete installation:
      icon_color: >
        {% set target_charge = states('input_number.target_charge'   )|int(10) %}
        {% set target_dischg = states('input_number.target_discharge')|int(20) %}
        {% set min_balanced = min(target_charge, target_dischg)          - 10  %}
        {% set max_balanced = max(target_charge, target_dischg)          + 10  %}
        {% if   min_balanced       <= this.state|float(0) and this.state|float(0) <= max_balanced       %}
          green
        {% elif min_balanced - 100 <= this.state|float(0) and this.state|float(0) <= max_balanced + 100 %}
          yellow
        {% else %}
          red
        {% endif %}

      # https://community.home-assistant.io/t/change-the-color-of-the-icon-of-a-virtual-sensor-depending-of-the-state/338658/14
      # cannot get this installed, so the following is ignored:
      templates:
        icon_color: 'red'

## https://github.com/andrey-git/home-assistant-custom-ui?tab=readme-ov-file
#customizer:
#  custom_ui: local

script:   !include scripts.yaml
scene:    !include scenes.yaml
# template: !include template.yaml


template:
# https://www.home-assistant.io/integrations/template/
# https://smarthomebastler.at/template-sensor-neu-und-effektiv-anlegen/
# https://smarthomeyourself.de/wiki/homeassistant/template-sensoren-von-der-alten-sensor-integration-auf-die-neue-template-integration-umstellen/

  - sensor:
      - name: power_balance
        unique_id: power_balance_id
        # friendly_name: "Power Balance" # " at distribution box"
        device_class: power
        unit_of_measurement: 'W'
        state: >
          {{ states('sensor.shelly3em_channel_a_power')|float
           + states('sensor.shelly3em_channel_b_power')|float
           + states('sensor.shelly3em_channel_c_power')|float }}
        # https://community.home-assistant.io/t/template-sensor-using-this-variable/420200/4
        # https://www.home-assistant.io/integrations/switch.template/#change-the-icon
        icon: >
          {% set target_charge = states('input_number.target_charge'   )|int(10) %}
          {% set target_dischg = states('input_number.target_discharge')|int(20) %}
          {% set min = min(target_charge, target_dischg)                   - 10  %}
          {% set max = max(target_charge, target_dischg)                   + 10  %}
          {% if min <= this.state|float(0) and this.state|float(0) <= max        %}
            mdi:scale-balance
          {% else %}
            mdi:scale-unbalanced
          {% endif %}

# https://community.home-assistant.io/t/use-last-value-instead-of-unknown/614331/4
# stable sensors using last known value of base sensor if current value is unknown

  - sensor:
      - name: power_production
        unique_id: power_production
        # friendly_name: "Power Production"  # - stable
        state: '{{ trigger.to_state.state }}'
        device_class: power
        unit_of_measurement: W
    trigger:
      - platform: state
        entity_id: sensor.power_production_unstable
        not_to:
          - unknown
          - unavailable

  - sensor:
      - name: power_charge
        unique_id: power_charge
        # friendly_name: "Charge power"  # - stable
        state: '{{ trigger.to_state.state }}'
        device_class: power
        unit_of_measurement: W
    trigger:
      - platform: state
        entity_id: sensor.power_charge_unstable
        not_to:
          - unknown
          - unavailable

  - sensor:
      - name: power_discharge
        unique_id: power_discharge
        # friendly_name: "Discharge power"  # - stable
        state: '{{ trigger.to_state.state }}'
        device_class: power
        unit_of_measurement: W
    trigger:
      - platform: state
        entity_id: sensor.power_discharge_unstable
        not_to:
          - unknown
          - unavailable

# prefer using MQTT for Shelly Plus 1PM input because Shelly integration only reports changes of at least 5%
# report 'unknown' or 'unavailable' (value from the Shelly integration) if both sources do not yield a number
mqtt:
  sensor:
      # reports the absolute value, or 0 if abs(value) < 0.9 because inverter drags ~0.7 W on standby
    - name: power_production_unstable
      unique_id: power_production_unstable
      # friendly_name: "Power production - stateless"
      state_topic: "pv1/status/switch:0"
      value_template: >-
        {% set val1 = value_json['apower'] %}
        {% set val2 = states('sensor.pv1_power') %}
        {% set val = val1 if is_number(val1) else val2 %}
        {{ (val|abs if val|abs >= 0.9 else 0) if is_number(val) else val }}
      # https://community.home-assistant.io/t/absolute-value-math/255232
      # need to use is_number() - see https://github.com/home-assistant/home-assistant.io/issues/30992
      unit_of_measurement: W
      device_class: power
      state_class: measurement

      # reports max(0, value)
      # HLG-600H drags 3.4 W on standby
    - name: power_charge_unstable  # beware: after quick reload, it can take 30+ seconds to recover from 'unknown'
      unique_id: power_charge_unstable
      # friendly_name: "Charge power - stateless"
      state_topic: "pm1/status/switch:0"
      value_template: >-
        {% set val1 = value_json['apower'] %}
        {% set val2 = states('sensor.pm1_power') %}
        {% set val = val1 if is_number(val1) else val2 %}
        {{ max(0, val) if is_number(val) else val }}
      unit_of_measurement: W
      device_class: power
      state_class: measurement

      # reports 0 if value < 0.5 to suppress flicker on standby
    - name: power_discharge_unstable
      unique_id: power_discharge_unstable
      # friendly_name: "Discharge power - stateless"
      state_topic: "pm2/status/switch:0"
      value_template: >-
        {% set val1 = value_json['apower'] %}
        {% set val2 = states('sensor.pm2_power') %}
        {% set val = val1 if is_number(val1) else val2 %}
        {{ (val if val >= 0.5 else 0) if is_number(val) else val }}
      unit_of_measurement: W
      device_class: power
      state_class: measurement

    - name: battery_voltage
      unique_id: battery_voltage
      # friendly_name: "Battery voltage"  # - stateless
      state_topic: "dtu/116181851168/1/voltage"
      unit_of_measurement: V

# sensor: !include sensor.yaml
sensor:
  - platform: template # https://www.home-assistant.io/integrations/template/
    sensors:

    # beware that adding needless derived sensors would be inefficient, see
    # https://www.shelly-support.eu/forum/thread/8977-shelly-3em-phasen-saldieren-in-home-assistant/?postID=218747#post218747

    # derived values needed for Riemann sums (integrations)

      power_import:  # on power_balance > 0
        unique_id: power_import_id
        friendly_name: "Power Import"
        device_class: power
        unit_of_measurement: 'W'
        value_template: >-
          {{ max([0, states('sensor.power_balance')|float(0)]) }}

      power_export:  # on power_balance < 0
        unique_id: power_export_id
        friendly_name: "Power Export"
        device_class: power
        unit_of_measurement: 'W'
        value_template: >-
          {{ max([0, 0 - states('sensor.power_balance')|float(0)]) }}

      power_consumption:
        unique_id: power_consumption_id
        friendly_name: "Power Consumption"
        device_class: power
        unit_of_measurement: 'W'
        availability_template: "{{ is_number(states('sensor.power_balance')) }}"
        value_template: >-
          {{ states('sensor.power_balance'   )|float    +
             states('sensor.power_production')|float(0) -
             states('sensor.power_charge'    )|float(0) +
             states('sensor.power_discharge' )|float(0) }}
      # for some reason, despite availability_template, still need to use '|float' see https://github.com/home-assistant/home-assistant.io/issues/30992

      power_own_use:
        unique_id: power_own_use_id
        friendly_name: "Power Own Use (self-consumption)"
        device_class: power
        unit_of_measurement: 'W'
        availability_template: "{{ is_number(states('sensor.power_consumption')) and
                                   is_number(states('sensor.power_production' )) }}"
        value_template: >-
          {{ min(states('sensor.power_consumption')|float, states('sensor.power_production')|float) }}
      # for some reason, despite availability still need to use '|float' - see https://github.com/home-assistant/home-assistant.io/issues/30992

#     # workaround for former issue with power production sensor, leading to yields unavailable untility_metervalue with unknown meaturement unit
#     energy0_production_hourly:
#       friendly_name: "Energy Production Hourly (workaround)"
#       device_class: energy
#       unit_of_measurement: 'kWh'
#       value_template: >-
#         {{ states('sensor.energy_consumption_hourly')|float(0) - states('sensor.energy_balance_hourly')|float(0) }}
#
#     # workaround for energy export data not always available
#     energy0_export_hourly:
#       friendly_name: "Energy Export Hourly (workaround)"
#       device_class: energy
#       unit_of_measurement: 'kWh'
#       value_template: >-
#         {{ states('sensor.energy_import_hourly')|float(0) - states('sensor.energy_balance_hourly')|float(0) }}

  # https://www.home-assistant.io/integrations/integration/
  # Riemann sums of power values (W) yielding energy (kWh)

  - name: energy_balance_sum
    source: sensor.power_balance
    platform: integration
    unit_prefix: k
    round: 3  # number of digits after comma on output (reading the sum value)
    method: left

  - name: energy_import_sum
    source: sensor.power_import
    platform: integration
    unit_prefix: k
    round: 3
    method: left

  - name: energy_export_sum
    source: sensor.power_export
    platform: integration
    unit_prefix: k
    round: 3
    method: left

  - name: energy_consumption_sum
    source: sensor.power_consumption
    platform: integration
    unit_prefix: k
    round: 3
    method: left

  - name: energy_production_sum
    source: sensor.power_production
    # no need to use float(0) here - see https://github.com/home-assistant/home-assistant.io/issues/30992
    platform: integration
    unit_prefix: k
    round: 3
    method: left

  - name: energy_charge_sum
    source: sensor.power_charge
    # no need to use float(0) here - see https://github.com/home-assistant/home-assistant.io/issues/30992
    platform: integration
    unit_prefix: k
    round: 3
    method: left

  - name: energy_discharge_sum
    source: sensor.power_discharge
    # no need to use float(0) here - see https://github.com/home-assistant/home-assistant.io/issues/30992
    platform: integration
    unit_prefix: k
    round: 3
    method: left

  - name: energy_own_use_sum
    source: sensor.power_own_use
    platform: integration
    unit_prefix: k
    round: 3
    method: left

  # Riemann sums of power values (W) yielding energy (Ws)

  - name: power_consumption_sum
    source: sensor.power_consumption
    platform: integration
    unit_time: s  # leads to wrong warning, see https://github.com/home-assistant/core/issues/107223
    round: 2
    method: left

  - name: power_production_sum
    source: sensor.power_production
    platform: integration
    unit_time: s  # leads to wrong warning, see https://github.com/home-assistant/core/issues/107223
    round: 2
    method: left

  - name: power_charge_sum
    source: sensor.power_charge
    platform: integration
    unit_time: s  # leads to wrong warning, see https://github.com/home-assistant/core/issues/107223
    round: 2
    method: left

  - name: power_discharge_sum
    source: sensor.power_discharge
    platform: integration
    unit_time: s  # leads to wrong warning, see https://github.com/home-assistant/core/issues/107223
    round: 2
    method: left

utility_meter: # https://www.home-assistant.io/integrations/utility_meter/
# energy accumulators that are reset per hour, day, month, or year

  energy_balance_hourly:
    name: Energy Balance Hourly
    source: sensor.energy_balance_sum
    net_consumption: true
    cycle: hourly
  energy_balance_daily:
    name: Energy Balance Daily
    source: sensor.energy_balance_sum
    net_consumption: true
    cycle: daily
  energy_balance_monthly:
    name: Energy Balance Monthly
    source: sensor.energy_balance_sum
    net_consumption: true
    cycle: monthly
  energy_balance_yearly:
    name: Energy Balance Yearly
    source: sensor.energy_balance_sum
    net_consumption: true
    cycle: yearly

  energy_import_hourly:
    name: Energy Import Hourly
    source: sensor.energy_import_sum
    cycle: hourly
  energy_import_daily:
    name: Energy Import Daily
    source: sensor.energy_import_sum
    cycle: daily
  energy_import_monthly:
    name: Energy Import Monthly
    source: sensor.energy_import_sum
    cycle: monthly
  energy_import_yearly:
    name: Energy Import Yearly
    source: sensor.energy_import_sum
    cycle: yearly

  energy_export_hourly:
    name: Energy Export Hourly
    source: sensor.energy_export_sum
    cycle: hourly
  energy_export_daily:
    name: Energy Export Daily
    source: sensor.energy_export_sum
    cycle: daily
  energy_export_monthly:
    name: Energy Export Monthly
    source: sensor.energy_export_sum
    cycle: monthly
  energy_export_yearly:
    name: Energy Export Yearly
    source: sensor.energy_export_sum
    cycle: yearly

  energy_consumption_hourly:
    name: Energy Consumption Hourly
    source: sensor.energy_consumption_sum
    cycle: hourly
  energy_consumption_daily:
    name: Energy Consumption Daily
    source: sensor.energy_consumption_sum
    cycle: daily
  energy_consumption_monthly:
    name: Energy Consumption Monthly
    source: sensor.energy_consumption_sum
    cycle: monthly
  energy_consumption_yearly:
    name: Energy Consumption Yearly
    source: sensor.energy_consumption_sum
    cycle: yearly

  energy_production_hourly:
    name: Energy Production Hourly  # Statistic id is derived from this: sensor.energy_production_hourly
    source: sensor.energy_production_sum
    net_consumption: true
    cycle: hourly
  energy_production_daily:
    name: Energy Production Daily
    source: sensor.energy_production_sum
    net_consumption: true
    cycle: daily
  energy_production_monthly:
    name: Energy Production Monthly
    source: sensor.energy_production_sum
    net_consumption: true
    cycle: monthly
  energy_production_yearly:
    name: Energy Production Yearly
    source: sensor.energy_production_sum
    net_consumption: true
    cycle: yearly

  energy_charge_hourly:
    name: Energy Charge Hourly
    source: sensor.energy_charge_sum
    net_consumption: true
    cycle: hourly
  energy_charge_daily:
    name: Energy Charge Daily
    source: sensor.energy_charge_sum
    net_consumption: true
    cycle: daily
  energy_charge_monthly:
    name: Energy Charge Monthly
    source: sensor.energy_charge_sum
    net_consumption: true
    cycle: monthly
  energy_charge_yearly:
    name: Energy Charge Yearly
    source: sensor.energy_charge_sum
    net_consumption: true
    cycle: yearly

  energy_discharge_hourly:
    name: Energy Discharge Hourly
    source: sensor.energy_discharge_sum
    net_consumption: true
    cycle: hourly
  energy_discharge_daily:
    name: Energy Discharge Daily
    source: sensor.energy_discharge_sum
    net_consumption: true
    cycle: daily
  energy_discharge_monthly:
    name: Energy Discharge Monthly
    source: sensor.energy_discharge_sum
    net_consumption: true
    cycle: monthly
  energy_discharge_yearly:
    name: Energy Discharge Yearly
    source: sensor.energy_discharge_sum
    net_consumption: true
    cycle: yearly

  energy_own_use_hourly:
    name: Energy Own_Use Hourly
    source: sensor.energy_own_use_sum
    net_consumption: true
    cycle: hourly
  energy_own_use_daily:
    name: Energy Own_Use Daily
    source: sensor.energy_own_use_sum
    net_consumption: true
    cycle: daily
  energy_own_use_monthly:
    name: Energy Own_Use Monthly
    source: sensor.energy_own_use_sum
    net_consumption: true
    cycle: monthly
  energy_own_use_yearly:
    name: Energy Own_Use Yearly
    source: sensor.energy_own_use_sum
    net_consumption: true
    cycle: yearly

  # used to generate load and PV profile:
  energy_consumption_minutely:
    name: Energy Consumption Minutely
    source: sensor.power_consumption_sum
    cron: "* * * * *"
  energy_production_minutely:
    name: Energy Production Minutely
    source: sensor.power_production_sum
    cron: "* * * * *"


notify: # https://www.home-assistant.io/integrations/file/

  - name: power_data
    platform: file
    filename: power.csv
    # timestamp: true
    services:

  - name: energy_data
    platform: file
    filename: energy.csv

  - name: profile_data
    platform: file
    filename: profile.csv

shell_command: # https://www.home-assistant.io/integrations/shell_command/  "When using templates, shell_command runs in a more secure environment ..."
# changes require HA restart, otherwise:  Error executing script. Service not found for call_service at pos N: Unable to find service shell_command.XYZ

# https://community.home-assistant.io/t/file-notification-component-any-way-to-dynamically-create-file-name/113062/11
  rename_power_by_date:   "mv -n power.csv   {{ (as_timestamp(now()) - 60) | timestamp_custom('power_%Y-%m-%d.csv') }}"
  rename_energy_by_year:  "mv -n energy.csv  {{ (as_timestamp(now()) - 60) | timestamp_custom('energy_%Y.csv') }}"
  rename_profile_by_year: "mv -n profile.csv {{ (as_timestamp(now()) - 60) | timestamp_custom('profile_%Y.csv') }}"

# failed attempts to append msg to profile without line break (newline) at msg end:
# append_to_profile:       echo -n >>profile.csv msg  # does nothing if 'msg' is replaced by parameter '{{msg}}'
# append_to_profile:       touch {{msg}}.csv          # test command - this correctly expands '{{msg}}' to 'test'

# automation: !include automations.yaml
automation:

  # at the end of each day, split and name power output file per day
  - id: run_rename_power_by_date
    initial_state: true
    trigger:
      - platform: time
        at: '23:59:59'
    action:
      - service: shell_command.rename_power_by_date

  # at the end of each year, split and name energy output file per year
  - id: run_rename_energy_by_year
    initial_state: true
    trigger:
      - platform: time
        at: '23:59:59'
    condition:
      - condition: template
        value_template: "{{ now().month == 12 and now().day == 31 }}"
    action:
      - service: shell_command.rename_energy_by_year

  # at the end of each year, split and name profile output file per year
  - id: run_rename_profile_by_year
    initial_state: true
    trigger:
      - platform: time
        at: '23:59:59'
    condition:
      - condition: template
        value_template: "{{ now().month == 12 and now().day == 31 }}"
    action:
      - service: shell_command.rename_profile_by_year


  # generate state output per second with power consumption, production, charge, discharge, and per each of the three phases
  - id: power_data_to_file
    initial_state: true
    trigger:
      - platform: time_pattern
        seconds: "/1"
    action:
      - variables: # https://www.home-assistant.io/docs/scripts/#variables
          time: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
          con : "{{ states('sensor.power_consumption'        ) }}"
        # bal : "{{ states('sensor.power_balance'            ) }}"
          prod: "{{ states('sensor.power_production'         ) }}"
          chrg: "{{ states('sensor.power_charge'             ) }}"
          disc: "{{ states('sensor.power_discharge'          ) }}"
          powA: "{{ states('sensor.shelly3em_channel_a_power') }}"
          powB: "{{ states('sensor.shelly3em_channel_b_power') }}"
          powC: "{{ states('sensor.shelly3em_channel_c_power') }}"
      - if: "{{ cons|float(-1) <= 0 }}"
        then:
          # https://www.home-assistant.io/integrations/system_log/
          - service: system_log.write
            data:
              message: "{{ 'power_consumption is not positive: %s' % cons }}"
              logger: home
              level: warning
      # on unavailable per-channel power values, do not output line of data
      - condition: "{{ is_number(powA) and is_number(powB) and is_number(powC)     }}"
      - variables:
          balance    : "{{ powA + powB + powC                                      }}"
          consumption: "{{ balance + prod|float(0) - chrg|float(0) + disc|float(0) }}"
      - service: notify.power_data
        data_template: # time zone: %z
          # not using 'con' above to avoid potential inconsistencies with earlier values of powA/powB/powC
          message: "{{ '%s,%7.2f,%s,%s,%s,%7.2f,%7.2f,%7.2f' %
                       (time, consumption,
                        ('%5.1f' % prod if prod != 0 else '    0') if is_number(prod) else '    ?',
                        ('%5.1f' % chrg if chrg != 0 else '    0') if is_number(chrg) else '    ?',
                        ('%5.1f' % disc if disc != 0 else '    0') if is_number(disc) else '    ?',
                        powA, powB, powC) }}"
      - service: light.turn_on
        target:
          entity_id: light.power_import
        data:
          brightness_pct: "{{ min(100, max(0, (balance - 30) * 100 / 200)) }}"  # TODO replace '30' by discharge target + 10
          # rgb_color: [ 255, 0, 0 ]  # is ignored for icon color
          # rgb_color: [ 255 if balance < 0 else 0, 0, 255 if balance >= 0 else 0]
      - service: light.turn_on
        target:
          entity_id: light.power_export
        data:
          brightness_pct: "{{ min(100, max(0, (0 - balance) * 100 / 200)) }}"  # TODO replace '0' by charge target - 10

  # generate statistics output per hour with energy consumption, production, charge, discharge, own use, balance, import, and export
  - id: energy_data_to_file
    trigger:
      - platform: time_pattern
        minutes: 59
        seconds: 59
    action:
      - variables:
          time: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
          cons: "{{ 1000 * states('sensor.energy_consumption_hourly')|float }}"
          prod: "{{ 1000 * states('sensor.energy_production_hourly' )|float }}"
          own:  "{{ 1000 * states('sensor.energy_own_use_hourly'    )|float }}"
          bal:  "{{ 1000 * states('sensor.energy_balance_hourly'    )|float }}"
          imp:  "{{ 1000 * states('sensor.energy_import_hourly'     )|float }}"
          exp:  "{{ 1000 * states('sensor.energy_export_hourly'     )|float }}"
          chrg: "{{ 1000 * states('sensor.energy_charge_hourly'     )|float }}"
          disc: "{{ 1000 * states('sensor.energy_discharge_hourly'  )|float }}"
          volt: "{{ states('sensor.battery_voltage') }}"
          # unavailable values intentionally lead to missing output line
      - service: notify.energy_data
        data_template:
          message: "{{ '%s,%4d,%4d,%4d,%4d,%4d,%4d,%4d,%4d' % (time, cons, prod, own, bal, imp, exp, chrg, disc) }},{{
                       '%2.1f' % volt if is_number(volt) else ' 0' }}"

  # generate load and PV profile with one line per minute containing average power values (W)
  - id: profile_data_to_file
    initial_state: true
    trigger:
      - platform: time_pattern
        seconds: 59
#       seconds: '*'
    action:
# failed attempts to append msg to profile without line break (newline) at msg end:
#     - service: shell_command.append_to_profile
#       data:
#         msg: "{{ 'test' }}"
      - variables:
          time: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
          cons: "{{ states('sensor.energy_consumption_minutely') }}"
          prod: "{{ states('sensor.energy_production_minutely' ) }}"
      # unavailable consumption value intentionally leads to missing output line
      - condition: "{{ is_number(cons) }}"
      - service: notify.profile_data
        data_template:
          message: "{{ time }},{{ '%7.2f' % (cons / 60) }},{{
                                  '%7.2f' % (prod / 60) if is_number(prod) else '      ?' }}"
